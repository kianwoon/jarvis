<!DOCTYPE html>
<html>
<head>
    <title>Debug KG Data Flow</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .step { margin: 20px 0; padding: 10px; background: #f5f5f5; }
        .error { background: #ffe6e6; }
        .success { background: #e6ffe6; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
    <h1>Debug Knowledge Graph Data Flow</h1>
    <div id="steps"></div>
    
    <script>
        async function debugDataFlow() {
            const stepsDiv = document.getElementById('steps');
            
            function addStep(title, data, isError = false) {
                const div = document.createElement('div');
                div.className = 'step ' + (isError ? 'error' : 'success');
                div.innerHTML = `<h3>${title}</h3><pre>${JSON.stringify(data, null, 2)}</pre>`;
                stepsDiv.appendChild(div);
            }
            
            try {
                // Step 1: Raw API call
                addStep('Step 1: Raw API Response', 'Fetching...');
                const response = await fetch('/api/v1/settings/knowledge_graph');
                const apiData = await response.json();
                stepsDiv.lastChild.innerHTML = `<h3>Step 1: Raw API Response</h3><pre>${JSON.stringify(apiData, null, 2)}</pre>`;
                
                // Step 2: Extract settings (simulate SettingsApp)
                const settingsData = apiData.settings || apiData;
                addStep('Step 2: Extracted Settings Data (settingsData = data.settings)', settingsData);
                
                // Step 3: Clean nested settings (simulate cleanNestedSettings)
                const cleanNestedSettings = (obj) => {
                    if (typeof obj !== 'object' || obj === null) return obj;
                    
                    const cleaned = Array.isArray(obj) ? [] : {};
                    const seenKeys = new Set();
                    
                    for (const [key, value] of Object.entries(obj)) {
                        let cleanKey = key;
                        
                        while (cleanKey.startsWith('settings.settings.')) {
                            cleanKey = cleanKey.replace('settings.settings.', '');
                        }
                        
                        if (cleanKey.startsWith('settings.') && 'knowledge_graph' !== 'settings') {
                            cleanKey = cleanKey.replace('settings.', '');
                        }
                        
                        if (!seenKeys.has(cleanKey)) {
                            seenKeys.add(cleanKey);
                            cleaned[cleanKey] = cleanNestedSettings(value);
                        }
                    }
                    
                    return cleaned;
                };
                
                const cleanedData = cleanNestedSettings(settingsData);
                addStep('Step 3: Cleaned Data (after cleanNestedSettings)', cleanedData);
                
                // Step 4: Extract model_config
                const modelConfig = cleanedData.model_config;
                addStep('Step 4: Model Config (cleanedData.model_config)', modelConfig);
                
                // Step 5: Check specific fields
                const fieldsCheck = {
                    model: modelConfig?.model,
                    temperature: modelConfig?.temperature,
                    repeat_penalty: modelConfig?.repeat_penalty,
                    system_prompt: modelConfig?.system_prompt,
                    max_tokens: modelConfig?.max_tokens,
                    context_length: modelConfig?.context_length,
                    model_server: modelConfig?.model_server
                };
                addStep('Step 5: Individual Fields Check', fieldsCheck);
                
                // Step 6: Final assessment
                const missingFields = Object.entries(fieldsCheck)
                    .filter(([key, value]) => value === undefined || value === null)
                    .map(([key]) => key);
                
                if (missingFields.length > 0) {
                    addStep('PROBLEM FOUND: Missing Fields', { 
                        missing_fields: missingFields,
                        diagnosis: 'These fields are missing from model_config in the database or API response'
                    }, true);
                } else {
                    addStep('SUCCESS: All Fields Present', { 
                        message: 'All model config fields are present. The issue must be in React component.'
                    });
                }
                
            } catch (error) {
                addStep('ERROR', { error: error.message }, true);
            }
        }
        
        debugDataFlow();
    </script>
</body>
</html>